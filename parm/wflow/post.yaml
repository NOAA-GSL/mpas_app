workflow:
  tasks:
    metatask_post:
      var:
        fhr: "{% for h in range(0, forecast.mpas['length'] + 1, 6) %}{{ ' %03d' % h }}{% endfor %}"
      task_mpassit_#fhr#:
        account: "{{ platform.account }}"
        command: 'source &MPAS_APP;/load_wflow_modules.sh &PLATFORM; ; &MPAS_APP;/scripts/mpassit.sh
          -m {{ user.mpas_app }}/src/MPASSIT/modulefiles/build.{{ user.platform }}.intel
          -w {{ user.experiment_dir }}/${CYCLE}/mpassit
          -f #fhr#
          -i ${CYCLE}
          -x {{ post.mpassit["fix_dir"] }}
          -p {{ user.mpas_app }}/parm/mpassit
          -e {{ user.mpas_app }}/exec'
        envars:
          CYCLE:
            cyclestr:
              value: '@Y@m@d@H'
          INIT_DIR:
            cyclestr:
              value: '{{ user.experiment_dir }}/@Y@m@d@H/mpas_ics'
          FCST_DIR:
            cyclestr:
              value: '{{ user.experiment_dir }}/@Y@m@d@H/forecast'
        join:
          cyclestr:
            value: '&LOGDIR;/{{ jobname }}_@Y@m@d@H.log'
        walltime: "{{ post.mpassit['execution']['batchargs']['walltime']}}"
        cores: !int "{{ post.mpassit['execution']['batchargs']['cores']}}"
        dependency:
          and:
            datadep_diag:
              attrs:
                age: 00:01:00
              value:
                cyclestr:
                  value: '{{ user.experiment_dir }}/@Y@m@d@H/forecast/</cyclestr><cyclestr offset="#fhr#:00:00">diag.@Y-@m-@d_@H.@M.@S.nc'
            datadep_history:
              attrs:
                age: 00:01:00
              value:
                cyclestr:
                  value: '{{ user.experiment_dir }}/@Y@m@d@H/forecast/</cyclestr><cyclestr offset="#fhr#:00:00">history.@Y-@m-@d_@H.@M.@S.nc'
